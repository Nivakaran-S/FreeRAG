name: Deploy to HuggingFace Spaces

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'notebooks/**'
      - '.gitignore'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true
      
      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install huggingface_hub
      
      - name: Deploy to HuggingFace Spaces
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_SPACE: ${{ secrets.HF_SPACE_NAME || 'FreeRag' }}
          HF_USERNAME: ${{ secrets.HF_USERNAME || 'nivakaran' }}
        run: |
          python << 'EOF'
          import os
          from huggingface_hub import HfApi, upload_folder
          
          api = HfApi()
          
          # Define files/folders to exclude from upload
          ignore_patterns = [
              ".git/*",
              ".github/*",
              ".venv/*",
              "venv/*",
              "__pycache__/*",
              "*.pyc",
              ".pytest_cache/*",
              "chroma_db/*",
              "data/*",
              "notebooks/*",
              "*.bin",
              "deploy/*",
              ".cache/*",
              "models/.cache/*",
          ]
          
          space_id = f"{os.environ['HF_USERNAME']}/{os.environ['HF_SPACE']}"
          print(f"ðŸš€ Deploying to: {space_id}")
          
          # Upload entire repo including models folder
          upload_folder(
              folder_path=".",
              repo_id=space_id,
              repo_type="space",
              ignore_patterns=ignore_patterns,
              token=os.environ["HF_TOKEN"],
          )
          
          print(f"âœ… Successfully deployed to https://huggingface.co/spaces/{space_id}")
          EOF